@page "/NewTransaction"
@using BankApp.Domain
@inject IAccountService AccountService
@inject NavigationManager Navigation

<h3>New Transaction</h3>

@if (_accounts.Count == 0)
{
    <p>No accounts available. Create an account first.</p>
}
else
{
    <div class="card p-4">
        <div class="form-group mb-3">
            <label for="account">Account:</label>
            <select id="account" class="form-control" @bind="_selectedAccountId">
                <option value="@Guid.Empty">-- Select Account --</option>
                @foreach (var acc in _accounts)
                {
                    <option value="@acc.Id">@acc.Name: @acc.Balance (@acc.Currency)</option>
                }
            </select>
        </div>

        <div class="form-group mb-3">
            <label for="type">Transaction Type:</label>
            <select id="type" class="form-control" @bind="_transactionType">
                <option value="@TransactionType.Deposit">Deposit</option>
                <option value="@TransactionType.Withdraw">Withdraw</option>
                <option value="@TransactionType.Interest">Apply Interest</option>
            </select>
        </div>
        
        @if (_transactionType == TransactionType.Interest)
        {
            <div class="form-group mb-3">
                <label for="rate">Interest rate (%)</label>
                <input id="rate" class="form-control" type="number" @bind="_interestRate"/>
            </div>
            <div class="form-group mb-3">
                <small>Amount will be calculated after current balance and interest rate</small>
            </div>
        }
        else
        {
            <div class="form-group mb-3">
                <label for="amount">Amount:</label>
                <input id="amount" class="form-control" @bind="_amount" type="number" step="0.01"/>
            </div>
        }
        <div class="form-group mb-3">
            <label for="description">Description:</label>
            <select id="description" class="form-select" @bind="_description">
                <option value="">Choose Description:</option>
                <option value="Food">Food</option>
                <option value="Rent">Rent</option>
                <option value="Clothes">Clothes</option>
                <option value="Other">Other</option>
            </select>
        </div>
        
        <button class="btn btn-primary" @onclick="SubmitTransaction">Submit</button>

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="alert alert-danger mt-3">@_errorMessage</div>
        }
    </div>
}

@code {
    private List<IBankAccount> _accounts = new();
    private Guid _selectedAccountId = Guid.Empty;
    private TransactionType _transactionType = TransactionType.Deposit;
    private decimal _amount;
    private string _errorMessage = string.Empty;
    private string? _description;
    private decimal _interestRate;
    
    protected override async Task OnInitializedAsync()
    {
        _accounts = await AccountService.GetAccountsAsync();
    }

    private async Task SubmitTransaction()
    {
        _errorMessage = string.Empty;

        if (_selectedAccountId == Guid.Empty)
        {
            _errorMessage = "Please select an account.";
            return;
        }

        var account = _accounts.FirstOrDefault(a => a.Id == _selectedAccountId);
        
        //Felhantering
        if (account == null)
        {
            _errorMessage = "Selected account could not be found.";
            return;
        }

        decimal amountToApply;

        if (_transactionType == TransactionType.Interest)
        {
            if (_interestRate <= 0)
            {
                _errorMessage = "Interest rate has to be more than 0";
                return;
            }
            
            //Calculate interest
            amountToApply = Math.Round(account.Balance * (_interestRate / 100m), 2);
            if (amountToApply == 0)
            {
                _errorMessage = "Calculated interest amount is 0";
                return;
            }
        }
        else
        {
            if (_amount <= 0)
            {
                _errorMessage = "Amount must be greater than zero.";
                return;
            }
            
            if (_transactionType == TransactionType.Withdraw && _amount > account.Balance)
            {
                _errorMessage = "Can't withdraw more than accounts available balance";
                return;
            }

            amountToApply = _amount;
        }

        var description = string.IsNullOrWhiteSpace(_description) //Faller tillbaka till deposit eller withdraw BARA om det inte finns någon description vald
            ? (_transactionType == TransactionType.Deposit ? "Deposit" :
                _transactionType == TransactionType.Withdraw ? "Withdraw" :
                _transactionType == TransactionType.Interest ? "Interest" : "Transaction")
            : _description;
        
        try
        {
            if (_transactionType == TransactionType.Deposit || _transactionType == TransactionType.Interest)
            {
                account.Deposit(
                    amountToApply,
                    toAccountId: account.Id,
                    fromAccountId: Guid.Empty,
                    description: description,
                    transactionType: _transactionType
                );
            }
            else
            {
                account.Withdraw(
                    amountToApply,
                    toAccountId: Guid.Empty,
                    fromAccountId: account.Id,
                    description: description,
                    transactionType: _transactionType
                );
            }

            await AccountService.UpdateAccount((BankAccount)account);
            Navigation.NavigateTo($"/TransactionHistory");
        }
        catch (ArgumentException exception)
        {
            _errorMessage = exception.Message;
        }
        catch (Exception exception)
        {
            _errorMessage = "An unexpected error occurred: " + exception.Message;
            Console.WriteLine(exception);
        }
    }

}